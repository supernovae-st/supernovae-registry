# Recipe Wizard ðŸ§™â€â™‚ï¸ðŸ³
# Generate a recipe from ingredients you have
#
# Usage:
#   INGREDIENTS="chicken, rice, tomatoes, garlic, onion" nika examples/public/recipe-wizard.nika.yaml
#   DIET="vegetarian" INGREDIENTS="tofu, mushrooms, soy sauce" nika examples/public/recipe-wizard.nika.yaml
#
# Pattern: Fan-out DAG (parallel analysis â†’ merge)
# Showcases: Parallel tasks, creative generation, structured output

schema: "nika/workflow@0.5"
workflow: recipe-wizard
description: "Generate a recipe from ingredients in your fridge"
provider: claude

tasks:
  # Step 1: Get ingredients
  - id: get_ingredients
    exec: "echo \"${INGREDIENTS:-eggs, cheese, bread, butter, tomatoes}\""

  # Step 2: Get dietary preferences
  - id: get_diet
    exec: "echo \"${DIET:-none}\""

  # Step 3: Analyze ingredients (parallel with cuisine matching)
  - id: analyze_ingredients
    use:
      ingredients: get_ingredients
    infer:
      prompt: |
        Analyze these ingredients: {{use.ingredients}}

        Output JSON:
        {
          "proteins": ["list proteins"],
          "vegetables": ["list vegetables"],
          "carbs": ["list carbs"],
          "seasonings": ["list seasonings"],
          "dairy": ["list dairy"],
          "missing_essentials": ["salt", "pepper", "oil if not listed"],
          "cuisine_matches": ["Italian", "Asian", "etc based on ingredients"]
        }
    output:
      format: json

  # Step 4: Generate 3 recipe options (parallel)
  - id: generate_options
    for_each: ["quick_easy", "impressive", "comfort_food"]
    as: style
    concurrency: 3
    use:
      ingredients: get_ingredients
      diet: get_diet
      analysis: analyze_ingredients
    infer:
      prompt: |
        Generate a {{use.style}} recipe using these ingredients.

        AVAILABLE: {{use.ingredients}}
        DIETARY: {{use.diet}}
        ANALYSIS: {{use.analysis}}

        Style guide:
        - quick_easy: Under 20 minutes, minimal steps
        - impressive: Fancy presentation, restaurant quality
        - comfort_food: Hearty, satisfying, cozy vibes

        Output JSON:
        {
          "style": "{{use.style}}",
          "name": "Recipe Name",
          "emoji": "ðŸ³",
          "time_minutes": 20,
          "difficulty": "easy/medium/hard",
          "servings": 2,
          "description": "One sentence pitch"
        }
    output:
      format: json

  # Step 5: Let user "pick" (in real app, would be interactive)
  - id: pick_recipe
    use:
      options: generate_options
    infer:
      prompt: |
        From these 3 recipe options, pick the most balanced one:
        {{use.options}}

        Output just the style name: quick_easy, impressive, or comfort_food
    output:
      format: text

  # Step 6: Generate full recipe
  - id: full_recipe
    use:
      ingredients: get_ingredients
      diet: get_diet
      style: pick_recipe
      analysis: analyze_ingredients
    infer:
      prompt: |
        Create a complete {{use.style}} recipe.

        INGREDIENTS: {{use.ingredients}}
        DIETARY: {{use.diet}}
        ANALYSIS: {{use.analysis}}

        Format:

        # ðŸ³ [Recipe Name]

        > [Catchy one-liner description]

        **â±ï¸ Time:** X minutes | **ðŸ‘¨â€ðŸ³ Difficulty:** Easy/Medium/Hard | **ðŸ½ï¸ Serves:** X

        ## ðŸ“ Ingredients
        - [ ] Item 1 (amount)
        - [ ] Item 2 (amount)

        ## ðŸ›’ You Might Need (optional additions)
        - Item that would enhance the dish

        ## ðŸ‘¨â€ðŸ³ Instructions

        ### Prep
        1. Step 1
        2. Step 2

        ### Cook
        1. Step 1
        2. Step 2

        ### Plate
        1. Plating instructions

        ## ðŸ’¡ Chef's Tips
        - Tip 1
        - Tip 2

        ## ðŸ· Pairs Well With
        - Drink suggestion
        - Side dish suggestion

        ---
        *Generated by Recipe Wizard ðŸ§™â€â™‚ï¸*

  # Step 7: Save
  - id: save
    use:
      recipe: full_recipe
    exec: |
      echo "{{use.recipe}}"
      echo ""
      echo "{{use.recipe}}" > /tmp/recipe.md
      echo "ðŸ“„ Recipe saved to /tmp/recipe.md"

flows:
  - source: get_ingredients
    target: analyze_ingredients
  - source: get_diet
    target: generate_options
  - source: analyze_ingredients
    target: generate_options
  - source: generate_options
    target: pick_recipe
  - source: pick_recipe
    target: full_recipe
  - source: analyze_ingredients
    target: full_recipe
  - source: full_recipe
    target: save
